# Telemetry for Toolbox

Telemetry data such as logs, metrics, and traces will help developers understand the internal state of the system.

Within Toolbox, we support the collection of all three telemetry data. Toolbox uses structured logging library [slog][slog] to record logs, and an observability framework [OpenTelemetry][opentel] to collect metrics and traces information.

These telemetry data are exported to the backends via the [Exporter](#exporter).


[slog]: https://pkg.go.dev/log/slog
[opentel]: https://opentelemetry.io/

## Before you begin
If you're using Google Cloud Monitoring, the following APIs will need to be enabled:

- logging.googleapis.com
- monitoring.googleapis.com
- cloudtrace.googleapis.com


## Telemetry data
### Logs
Toolbox supports both standard and structured logging format. User will be able to customize logging with the following flags when running Toolbox:

| **flag** | **description** |
|----------|-----------------|
| `--log-level` | Preferred log level, allowed values: `debug`, `info`, `warn`, `error`. Default: `info`. |
| `--logging-format` | Preferred logging format, allowed values: `standard`, `json`. Default: `standard`. |

#### Example:

```bash
./toolbox --tools_file "tools.yaml" --log-level warn --logging-format json
```

### Metric and Trace
The following flag could be used to determine OpenTelemetry configuration:

| **flag** | **type** | **description** |
|-------------------------------|----------|-----------------|
| `--telemetry-gcp`          | bool | Enable exporting directly to Google Cloud Monitoring. Default as `false`. |
| `--telemetry-otlp`  | string | Enable exporting using OpenTelemetry Protocol (OTLP) to the specified endpoint (e.g. 'http://127.0.0.1:4318'). |
| `--telemetry-service-name`         | string | Sets the value of the `service.name` resource attribute. Default as `toolbox`. |

In addition to the flags noted above, you can also make additional configuration for OpenTelemetry via the [General SDK Configuration][sdk-configuration] through environmental variables.

[sdk-configuration]: https://opentelemetry.io/docs/languages/sdk-configuration/general/

#### Resource Attribute
All metrics and traces generated within Toolbox will be associated with a unified [resource][resource]. The list of resource attributes included are:

| **Resource Name** | **Description** |
|-------------------|-----------------|
| [TelemetrySDK](https://pkg.go.dev/go.opentelemetry.io/otel/sdk/resource#WithTelemetrySDK) | TelemetrySDK version info. |
| [OS](https://pkg.go.dev/go.opentelemetry.io/otel/sdk/resource#WithOS) | OS attributes including OS description and OS type. |
| [Container](https://pkg.go.dev/go.opentelemetry.io/otel/sdk/resource#WithContainer) | Container attributes including container ID, if applicable. |
| [Host](https://pkg.go.dev/go.opentelemetry.io/otel/sdk/resource#WithHost) | Host attributes including host name. |
| [SchemaURL](https://pkg.go.dev/go.opentelemetry.io/otel/sdk/resource#WithSchemaURL) | Sets the schema URL for the configured resource. |
| service.name | Open telemetry service name. Defaulted to `toolbox`. User can set the service name via flag mentioned above to distinguish between different toolbox service. |
| service.version | The version of Toolbox used. |


[resource]: https://opentelemetry.io/docs/languages/js/resources/

#### Metric
Toolbox provides the following custom metrics:

| **Metric Name** | **Description** |
|-----------------|-----------------|
| toolbox.server.toolset.get.count | Count the number of toolset manifest request served |
| toolbox.server.tool.get.count | Count the number of tool manifest request served |
| toolbox.server.tool.get.invoke | Count the number of tool invocation request served |

All custom metrics have the following attributes/labels:

| **Metric Attributes** | **Description** |
|-----------------|-----------------|
| toolbox.name | Name of the toolset or tool, if applicable. |
| toolbox.status | Operation status code, for example: `success`, `failure`. |

#### Trace
Spans are generated within Toolbox to track the path of a requests through a server application.

Spans generated by Toolbox server is prefixed with `toolbox/server/`. For example, when user run Toolbox, it will generate spans for the following, with `toolbox/server/init` as the root span:

`toolbox/server/init`
- `toolbox/server/source/init` - Attribute: `source_kind`, `source_name`
  - `toolbox/server/source/connect` - Attribute: `source_kind`, `source_name`
- `toolbox/server/tool/init` - Attribute: `tool_kind`, `tool_name`
- `toolbox/server/toolset/init` - Attribute: `toolset_name`
- `toolbox/server/auth/init` - Attribute: `auth_kind`, `auth_name`

## Exporter
Toolbox provide two types of exporter implementation for user to choose from. 

### Google Cloud Exporter
The google cloud exporter directly exports telemetry to google cloud platform monitoring. It utilizes the [GCP Metric Exporter][gcp-metric-exporter] and [GCP Trace Exporter][gcp-trace-exporter].

[gcp-metric-exporter]: https://github.com/GoogleCloudPlatform/opentelemetry-operations-go/tree/main/exporter/metric
[gcp-trace-exporter]: https://github.com/GoogleCloudPlatform/opentelemetry-operations-go/tree/main/exporter/trace

Usage example:

```bash
./toolbox --telemetry-gcp
```

### OTLP Exporter
This implementation uses the default OTLP exporter over HTTP for [metrics][otlp-metric-exporter] and [traces][otlp-trace-exporter]. You can use this exporter if you choose to export your telemetry data via a collector.

Usage example:

```bash
./toolbox --telemetry-otlp=http://127.0.0.1:4553
```

[otlp-metric-exporter]: https://opentelemetry.io/docs/languages/go/exporters/#otlp-traces-over-http
[otlp-trace-exporter]: https://opentelemetry.io/docs/languages/go/exporters/#otlp-traces-over-http

## Collector
Toolbox provide an option to export telemetry data to user's choice of backend(s) that are compatible with the Open Telemetry Protocol (OTLP). If you would like to use a collector, please refer to this [guide](./guide_collector.md).
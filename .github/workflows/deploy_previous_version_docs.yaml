# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: "Deploy Previous Version Docs"

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'The old version tag to build docs for (e.g., v0.15.0)'
        required: true
        type: string

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main branch (for latest templates and theme)
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          ref: 'main'
          submodules: 'recursive'
          fetch-depth: 0

      - name: Checkout old content from tag into a temporary directory
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          ref: ${{ github.event.inputs.version_tag }}
          path: 'old_version_source' # Checkout into a temp subdir
          # Sparse checkout to only get the content directory
          sparse-checkout: |
            docs

      - name: Replace content with old version
        run: |
          # Remove the current content directory from the main branch checkout
          rm -rf docs/
          # Move the old content directory into place
          mv ./old_version_source/docs docs

      - name: Setup Hugo and Node
        uses: peaceiris/actions-hugo@75d2e84710de30f6ff7268e08f310b60ef14033f # v3
        with:
          hugo-version: "0.145.0"
          extended: true
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "22"

      - name: Install Dependencies
        run: npm ci
        working-directory: .hugo

      - name: Build Hugo Site for Archived Version
        run: hugo --minify
        working-directory: .hugo
        env:
          HUGO_BASEURL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.event.inputs.version_tag }}/
          HUGO_RELATIVEURLS: false

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .hugo/public
          publish_branch: versioned-gh-pages
          destination_dir: ./${{ github.event.inputs.version_tag }}
          keep_files: true
          allow_empty_commit: true
          commit_message: "docs(backport): deploy docs for ${{ github.event.inputs.version_tag }}"

      - name: Clean Build Directory
        run: rm -rf .hugo/public

      - name: Build Hugo Site
        run: hugo --minify
        working-directory: .hugo
        env:
          HUGO_BASEURL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          HUGO_RELATIVEURLS: false

      - name: Deploy to root
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .hugo/public
          publish_branch: versioned-gh-pages
          keep_files: true
          allow_empty_commit: true
          commit_message: "deploy: docs to root for ${{ github.event.inputs.version_tag }}"
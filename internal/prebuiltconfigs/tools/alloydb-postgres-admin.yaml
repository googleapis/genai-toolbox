# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

sources:
  alloydb-api-source:
    kind: http
    baseUrl: https://alloydb.googleapis.com
    headers:
      Authorization: Bearer ${API_KEY}
      Content-Type: application/json
  alloydb-admin-source:
    kind: alloydb-admin
tools:
  create_cluster:
    kind: http
    source: alloydb-api-source
    method: POST
    path: /v1/projects/{{.projectId}}/locations/{{.locationId}}/clusters
    description: "Create a new AlloyDB cluster. This is a long-running operation, but the API call returns quickly. This will return operation id to be used by get operations tool. Take all parameters from user in one go."
    pathParams:
      - name: projectId
        type: string
        description: "The dynamic path parameter for project id provided by user."
      - name: locationId
        type: string
        description: "The dynamic path parameter for location. The default value is us-central1. If quota is exhausted then use other regions."
        default: us-central1
    queryParams:
      - name: clusterId
        type: string
        description: "A unique ID for the AlloyDB cluster."
    requestBody: |
      {
        "networkConfig": {
          "network": "projects/{{.project}}/global/networks/{{.network}}"
        },
        "initialUser": {
          "password": "{{.password}}",
          "user": "{{.user}}"
        }
      }
    bodyParams:
      - name: project
        type: string
        description: "The dynamic path parameter for project id."
      - name: network
        type: string
        description: "The name of the VPC network to connect the cluster to (e.g., 'default')."
        default: default
      - name: password
        type: string
        description: "A secure password for the initial 'postgres' user or the custom user provided."
      - name: user
        type: string
        description: "The name for the initial superuser. If not provided, it defaults to 'postgres'. The initial database will always be named 'postgres'."
  wait_for_operation:
    kind: alloydb-wait-for-operation
    description: "This will poll on operations API until the operation is done. For checking operation status we need projectId, locationID and operationId. Once instance is created give follow up steps on how to use the variables to bring data plane MCP server up in local and remote setup."
    delay: 1s
    maxDelay: 4m
    multiplier: 2
    maxRetries: 10
  create_instance:
    kind: http
    source: alloydb-api-source
    method: POST
    path: /v1/projects/{{.projectId}}/locations/{{.locationId}}/clusters/{{.clusterId}}/instances
    description: "Creates a new AlloyDB instance (PRIMARY, READ_POOL, or SECONDARY) within a cluster. This is a long-running operation. Take all parameters from user in one go. This will return operation id to be used by get operations tool."
    pathParams:
      - name: projectId
        type: string
        description: "The GCP project ID."
      - name: locationId
        type: string
        description: "The location of the cluster (e.g., 'us-central1')."
        default: us-central1
      - name: clusterId
        type: string
        description: "The ID of the cluster to create the instance in."
    queryParams:
      - name: instanceId
        type: string
        description: "A unique ID for the new AlloyDB instance."
    requestBody: |
      {
        "instanceType": "{{.instanceType}}",
        {{- if .displayName }}
        "displayName": "{{.displayName}}",
        {{- end }}
        {{- if eq .instanceType "READ_POOL" }}
        "readPoolConfig": {
          "nodeCount": {{.nodeCount}}
        },
        {{- end }}
        {{- if eq .instanceType "SECONDARY" }}
        "secondaryConfig": {
          "primaryClusterName": "{{.primaryClusterName}}"
        },
        {{- end }}
        "networkConfig": {
          "enablePublicIp": true
        },
        "databaseFlags": {
          "password.enforce_complexity": "on"
        }
      }
    bodyParams:
      - name: instanceType
        type: string
        description: "The type of instance to create. Required. Valid values are: PRIMARY, READ_POOL, SECONDARY."
      - name: displayName
        type: string
        description: "An optional, user-friendly name for the instance."
      - name: nodeCount
        type: integer
        description: "The number of nodes in the read pool. Required only if instanceType is READ_POOL. Default is 1."
        default: 1
      - name: primaryClusterName
        type: string
        description: "The full resource name of the primary cluster for a SECONDARY instance. Required only if instanceType is SECONDARY. Otherwise don't ask"
        default: ""
  list_clusters:
      kind: alloydb-list-clusters
      source: alloydb-admin-source
      description: "Lists all AlloyDB clusters in a given project and location."
  list_instances:
    kind: alloydb-list-instances
    source: alloydb-admin-source
    description: "Lists all AlloyDB instances within a specific cluster."
  list_users:
    kind: alloydb-list-users
    source: alloydb-admin-source
    description: "Lists all database users within a specific AlloyDB cluster."
  create_user:
    kind: alloydb-create-user
    source: alloydb-admin-source
    description: "Creates a new database user in an AlloyDB cluster. Takes the new user's name and a secure password. Optionally, a list of database roles can be assigned. Always ask the user for the type of user to create. ALLOYDB_IAM_USER is recommended."
  get_cluster:
    kind: alloydb-get-cluster
    source: alloydb-admin-source
    description: "Retrieves details of a specific AlloyDB cluster."
  get_instance:
    kind: alloydb-get-instance
    source: alloydb-admin-source
    description: "Retrieves details of a specific AlloyDB instance."
  get_user:
    kind: alloydb-get-user
    source: alloydb-admin-source
    description: "Retrieves details of a specific AlloyDB user."
        
toolsets:
  alloydb_postgres_admin_tools:
    - create_cluster
    - wait_for_operation
    - create_instance
    - list_clusters
    - list_instances
    - list_users
    - create_user
    - get_cluster
    - get_instance
    - get_user
